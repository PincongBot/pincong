{"type":"video_comment","id":15561,"parentType":"video","parentId":1563,"uid":18160,"contents":"火狐的DoH代码讲解<br>\n<br>\n參考代碼 <br>\n<pre>netwerk/dns/TRR.cpp</pre><br>\n的 <br>\n<pre>TRR::SendHTTPRequest()</pre><br>\n函數<br>\n<br>\n雖然代碼很長，但是<b>實際工作的就是拼一個https報文</b><br>\n分兩種情況，只能選其中一種<br>\n<br>\n情況1：你選擇發送Get請求，<br>\n<pre>DohEncode</pre><br>\n生成一個tmp，對tmp 進行base64編碼，追加到uri裏，調用<br>\n<pre>httpChannel-&gt;AsyncOpen(this);</pre><br>\n發送HTTP請求<br>\n<br>\n情況2：你選擇發送Post請求，<br>\n<pre>DohEncode</pre><br>\n生成一個body，通過<br>\n<pre>uploadChannel-&gt;ExplicitSetUploadStream</pre><br>\n放到http的body部分，調用<br>\n<pre>httpChannel-&gt;AsyncOpen(this);</pre><br>\n發送HTTP請求<br>\n<br>\n<br>\n通過<br>\n<pre>TRR::OnDataAvailable</pre><br>\n函数收到應答報文，只看代碼<br>\n<pre>On200Response</pre><br>\n，先不考慮異常情況<br>\n<br>\nDohDecode會解析應答報文，放到mDNS裏<br>\n<br>\n最後調用<br>\n<pre>TRR::ReturnData</pre><br>\n返回查詢結果，mHostResolver-&gt;CompleteLookup<br>\n<br>\n<br>\n<b>必須TRR打開，ESNI功能才能使用</b>","date":"2020-04-12","agreeCount":0,"discussionCount":0}