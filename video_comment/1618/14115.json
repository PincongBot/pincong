{"type":"video_comment","id":14115,"parentType":"video","parentId":1618,"uid":20551,"contents":"<center><b>Tor如何建立通信链路</b></center><br>\n<br>\n先回顾一下TLS握手。。。<br>\n<br>\n1. 客户端发送ClientHello。<br>\n2. 服务器发送ServerHello，把签名后的公钥发给客户端。<br>\n3. 客户端<b>验证</b>证书有效后，把一个随机数用服务器的公钥加密后，发送CertVerify<br>\n4. 服务器用私钥解开随机数；根据前面的随机数，服务器和客户端用相同的方法生成session key，发送ServerFin建立会话。<br>\n<br>\n建立Tor链路的过程:<br>\n0. 客户端向目录服务器发出请求，拿到节点列表。<br>\n<br>\n1. <br>\n<ul><li>客户端选出第一个节点，叫做葱1。葱1的公钥记作PK1，葱1把自己的公钥签名后发给客户端。拿到可信的公钥之后，就可以建立<b>TLS连接</b>了。</li></ul><br>\n<br>\n2. <br>\n<ul><li>客户端选出第二个节点，叫做葱2；客户端用PK1加密葱2的地址，并把加密后的信息发给葱1。</li><li>葱1用私钥解密地址，发现要求自己和葱2建立连接，就根据此地址与葱2建立连接。</li><li>葱2的公钥记作PK2，葱2把自己的公钥签名后，通过葱1发给客户端。</li></ul><br>\n<br>\n3. <br>\n<ul><li>客户端选出第三个节点，叫做葱3；客户端依次用PK2加密葱3的地址，然后附上葱2的地址，再用PK1加密一次。然后，把加密后的信息发给葱1。</li><li>葱1用私钥解密地址，发现是葱2的地址，就把数据包转发给葱2。</li><li>葱2用私钥解密地址，发现要求自己和葱3建立连接，就根据此地址与葱3建立连接。</li><li>葱3的公钥记作PK3，葱3把自己的公钥签名后，通过葱2，葱1发给客户端。</li></ul>","date":"2020-03-28","agreeCount":3,"discussionCount":0}