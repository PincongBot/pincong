{"type":"video_comment","id":14286,"parentType":"video","parentId":1618,"uid":44379,"contents":"<center><b>制作Tor网关虚拟机的方法</b></center><br>\n基本原理是，双虚拟机隔离保护匿名，VPN+Tor隐藏流量特征。具体可以参考编程随想的文章：<br>\nhttps://program-think.blogspot.com/2013/01/howto-cover-your-tracks-6.html<br>\nhttps://program-think.blogspot.com/2015/04/howto-cover-your-tracks-8.html<br>\n<br>\n我使用Tor前置部署方案，即【网关虚拟机】里安装VPN开源客户端和Tor，上网软件安装在【隔离虚拟机】里，隔离虚拟机的全部(TCP)流量走网关，见图：<br>\n<a href=\"https://i.imgur.com/FxT7vJX.png\" rel=\"nofollow noreferrer noopener\" target=\"_blank\"><img src=\"https://i.imgur.com/FxT7vJX.png\" alt=\"https://i.imgur.com/FxT7vJX.png\" style=\"max-width:100%\"></a><br>\n虚拟化软件使用VirtualBox。<br>\n<br>\n<center><b>Step1：安装网络</b></center><br>\n网关虚拟机配置三张网卡：<br>\n<br>\n<b>eth0：</b>连接到VirtualBox自带的NAT网络，可以直接上网。eth0的IP交给系统自动管理即可。<br>\n<br>\n<b>eth1：</b>较旧的双虚拟机互联大多使用host-only模式。host-only模式下流量要通过主机网络栈，有安全风险。新版VirtualBox自带一个“内部网络”模式，内部网络由VirtualBox管理，仅虚拟机可见，与主机没有任何交互。这里设置eth1的网络为192.168.89.0/24，网关虚拟机地址为192.168.89.64。VirtualBox的内部网络使用【界面名称】来唯一标识每一个网络。这里界面名称叫【tor-intnet】.<br>\n<br>\n<b>eth2：</b>可选，配置一个host-only网络，可以用来SSH。<b>不用时关掉</b>。在VirtualBox里新建一个主机网络192.168.12.0/24，eth2地址设置为192.168.12.64。<br>\n<br>\n最后，VirtualBox的文档里推荐，如果操作系统支持，虚拟网卡控制芯片尽量选virtio-net，速度更快。<br>\n然后打开网关虚拟机，配置interfaces. 在/etc/network/interfaces里面，增加以下内容：<br>\n<pre>auto eth1<br>\niface eth1 inet static<br>\naddress 192.168.89.64<br>\n<br>\nauto eth2<br>\niface eth2 inet static<br>\naddress 192.168.12.64</pre><br>\n<center><b>Step2：安装V2Ray</b></center><br>\n用V2Ray作为Tor的前置代理，可以用真正的TLS流量包装Tor流量，外人看上去就是在访问无害的网站。<br>\n首先下载v2ray：<br>\n<pre>wget https://github.com/v2ray/v2ray-core/releases/download/v4.23.1/v2ray-linux-64.zip</pre><br>\n然后切进v2ray的目录，修改config.json，我这里的配置是V2Ray+WS+TLS+Web+CDN，一步到位：<br>\n<pre>{<br>\n\"inbound\": {<br>\n&nbsp; &nbsp; \"protocol\": \"socks\",<br>\n&nbsp; &nbsp; \"port\": 10086,<br>\n&nbsp; &nbsp; \"listen\": \"127.0.0.1\"<br>\n},<br>\n<br>\n\"outbound\": {<br>\n&nbsp; &nbsp; \"protocol\": \"vmess\",<br>\n&nbsp; &nbsp; \"settings\": {\"vnext\": [{<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"address\": \"域名\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"port\": 443,<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"users\": [{\"id\": \"UUID\"}]<br>\n&nbsp; &nbsp; }]},<br>\n&nbsp; &nbsp; \"streamSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"network\": \"ws\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"security\": \"tls\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"tlsSettings\": {\"serverName\": \"域名\"},<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"wsSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"headers\": {\"Host\": \"域名\"},<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"path\": \"ws路径\"<br>\n&nbsp; &nbsp; &nbsp; &nbsp; }<br>\n&nbsp; &nbsp; },<br>\n&nbsp; &nbsp; \"mux\": {\"enabled\": true}<br>\n}<br>\n}</pre><br>\nsocks5端口是万年不变的10086。然后把v2ray解压出来的v2ray.service拷贝到systemd下，运行：<br>\n<pre>systemctl restart v2ray</pre><br>\nv2ray就搭建好了。<br>\n<br>\n<center><b>Step3：安装Tor</b></center><br>\n安装：<br>\n<pre>pkg install tor</pre><br>\n安装完成以后打开/etc/tor/torrc，在后面增加：<br>\n<pre>Socks5Proxy 127.0.0.1:10086<br>\n<br>\nSOCKSPort 192.168.89.64:9050<br>\nSOCKSPolicy accept 192.168.89.0/24</pre><br>\n然后运行：<br>\n<pre>systemctl restart tor</pre><br>\n网关虚拟机就制作完成了。<br>\n<br>\n<center><b>Step4：使用网关虚拟机</b></center><br>\n按照上面的配置，网络参数如下：<br>\n<ul><li>界面名称：tor-intnet</li><li>网络号：192.168.89.0/24</li><li>网关IP：192.168.89.64</li><li>Socks5端口：9050</li></ul><br>\n<br>\n注意【隔离虚拟机】只能有一张网卡，而且网卡的模式必须是【内部网络】，否则起不到隔离的效果。<br>\n<br>\n在VirtualBox里，网卡的界面名称填tor-intnet，进入虚拟机，网卡配置填：<br>\n<pre>auto eth0<br>\niface eth0 inet static<br>\naddress 192.168.89.2</pre><br>\n这是因为内部网络模式不会自动分配IP，所以必须手动指定如果要使用动态IP，可以在宿主机里添加DHCP：<br>\n<pre>vboxmanage dhcpserver add --netname tor-intnet --ip 192.168.89.1 --netmask&nbsp; 255.255.255.0 --lowerip 192.168.89.2 --upperip 192.168.89.254 -enable</pre><br>\n以下命令可以删除已添加的DHCP服务器：<br>\nvboxmanage dhcpserver remove --netname tor-intnet<br>\n<br>\nVirtualBox的manual见：https://www.virtualbox.org/manual<br>\n<br>\n设置完网络后，对【隔离虚拟机】中的任何软件，只要配置socks5代理，就可以用Tor+VPN上网了。反过来说，只要软件配置了socks5，那么它的流量一定经过了Tor+VPN。而其它任何没有配置socks的流量，都无法穿出隔离虚拟机，更不用说联网了。<br>\n<b>如果软件要联网，可以配置以下sock5代理：192.168.89.64:9050</b><br>\n<br>\n如果要在隔离虚拟机里使用系统代理，可以使用privoxy:<br>\npkg install privoxy<br>\n<br>\n然后打开配置文件/etc/privoxy/config，末尾添加：<br>\nforward-socks5t / 192.168.89.64:9050 .<br>\nforward localhost/ .<br>\n<br>\n就可以设置本地全局代理。","date":"2020-03-31","agreeCount":4,"discussionCount":0}