{"type":"video_comment","id":15235,"parentType":"video","parentId":1618,"uid":20551,"contents":"<pre><br>\n#!/bin/bash<br>\necho \"installation beginning\"<br>\nprintf \"Input domain name: \"<br>\nread domain<br>\nprintf \"Input websocket path: \"<br>\nread wspath<br>\n<br>\nmkdir tmp<br>\nwget \"https://caddyserver.com/download/linux/amd64?license=personal&amp;telemetry=off\" -O tmp/caddy.tar.gz<br>\nwget \"https://github.com/v2ray/v2ray-core/releases/download/v4.23.1/v2ray-linux-64.zip\" -O tmp/v2ray.zip<br>\ngunzip tmp/caddy.tar.gz<br>\ntar -xvf tmp/caddy.tar -C tmp/<br>\nunzip tmp/v2ray.zip -d tmp/<br>\n<br>\nmkdir -p /opt/breakwall /opt/breakwall/ssl /opt/breakwall/html<br>\ncp tmp/caddy /opt/breakwall/<br>\ncp tmp/v2ray /opt/breakwall/<br>\ncp tmp/v2ctl /opt/breakwall/<br>\ncp tmp/geoip.dat /opt/breakwall/<br>\ncp tmp/geosite.dat /opt/breakwall/<br>\nrm -rf tmp/<br>\n<br>\nopenssl genrsa -out /opt/breakwall/ssl/ca.key 2048<br>\nopenssl req -new -key /opt/breakwall/ssl/ca.key -out /opt/breakwall/ssl/ca.csr -subj \"/CN=$domain\"<br>\nopenssl req -x509 -days 3650 -key /opt/breakwall/ssl/ca.key -in /opt/breakwall/ssl/ca.csr -out /opt/breakwall/ssl/ca.crt<br>\n<br>\ncat &lt;&lt; EOF &gt; /opt/breakwall/Caddyfile<br>\nhttps://$domain<br>\ntls /opt/breakwall/ssl/ca.crt /opt/breakwall/ssl/ca.key<br>\nroot /opt/breakwall/html<br>\nproxy /$wspath https://127.0.0.1:8964<br>\nEOF<br>\n<br>\ncat &lt;&lt; EOF &gt; /opt/breakwall/config.json<br>\n{<br>\n\"inbound\": {<br>\n    \"listen\": \"127.0.0.1\",<br>\n    \"port\": 8964,<br>\n    \"protocol\": \"socks\",<br>\n    \"settings\": {\"udp\": true},<br>\n    \"streamSettings\": {<br>\n        \"wsSettings\": {\"path\": \"/$wspath\"},<br>\n        \"network\": \"ws\"<br>\n    }<br>\n},<br>\n\"outbound\": {\"protocol\": \"freedom\"}<br>\n}<br>\nEOF<br>\n<br>\ncat &lt;&lt; EOF &gt; /etc/systemd/system/caddy.service<br>\n[Unit]<br>\nAfter=network-online.target<br>\nWants=network-online.target systemd-networkd-wait-online.service<br>\n[Service]<br>\nType=simple<br>\nUser=breakwall<br>\nExecStart=/opt/breakwall/caddy -conf=/opt/breakwall/Caddyfile -agree=true<br>\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE<br>\nAmbientCapabilities=CAP_NET_BIND_SERVICE<br>\nNoNewPrivileges=true<br>\nRestart=on-abnormal<br>\n[Install]<br>\nWantedBy=multi-user.target<br>\nEOF<br>\n<br>\ncat &lt;&lt; EOF &gt; /etc/systemd/system/v2ray.service<br>\n[Unit]<br>\nAfter=network.target nss-lookup.target<br>\nWants=network-online.target<br>\n[Service]<br>\nType=simple<br>\nUser=breakwall<br>\nExecStart=/opt/breakwall/v2ray<br>\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_NET_RAW<br>\nNoNewPrivileges=yes<br>\nRestart=on-failure<br>\nRestartPreventExitStatus=23<br>\n[Install]<br>\nWantedBy=multi-user.target<br>\nEOF<br>\n<br>\nrand_str=<br>\nfunction random_string() {<br>\n    rand_num=$(($(date +%s%N)%$(($2-$1+1))+$1))<br>\n    rand_str=$(cat /dev/urandom | tr -dc 'a-z' | fold -w ${rand_num} | head -n 1)<br>\n}<br>\n<br>\nrandom_string 5 20<br>\ntitle=$rand_str<br>\nrandom_string 5 20<br>\nheader=$rand_str<br>\n<br>\nMIN_LINE=100<br>\nMAX_LINE=200<br>\nn_paragraphs=$(($(date +%s%N)%$(($MAX_LINE-$MIN_LINE+1))+$MIN_LINE))<br>\nrandom_string 50 120<br>\nparagraph=$rand_str<br>\n<br>\ni=0<br>\nwhile(($i&lt;n_paragraphs))<br>\ndo<br>\n    random_string 50 120<br>\n    paragraph=\"${paragraph}&lt;br /&gt;${rand_str}\"<br>\n    let \"i++\"<br>\ndone<br>\n<br>\n<br>\ncat &lt;&lt; EOF &gt; /opt/breakwall/html/index.html<br>\n&lt;html&gt;<br>\n&lt;head&gt;<br>\n&lt;title&gt;${title}&lt;/title&gt;<br>\n&lt;/head&gt;<br>\n&lt;body&gt;<br>\n&lt;h1&gt;${header}&lt;/h1&gt;<br>\n&lt;p&gt;${paragraph}&lt;/p&gt;<br>\n&lt;/body&gt;<br>\n&lt;/html&gt;<br>\nEOF<br>\n<br>\nuseradd --system --home-dir /nonexistent --shell /sbin/nologin breakwall<br>\nchown -R breakwall:breakwall /opt/breakwall/html<br>\nchown -R breakwall:breakwall /opt/breakwall/ssl<br>\nchmod 700 /opt/breakwall/ssl<br>\nchmod +x /opt/breakwall/v2ray /opt/breakwall/v2ctl /opt/breakwall/caddy<br>\n<br>\nsystemctl daemon-reload<br>\nsystemctl enable caddy v2ray --now<br>\necho \"Installation finished.\"<br>\n<br>\n</pre>","date":"2020-04-07","agreeCount":2,"discussionCount":0}