{"type":"article_comment","id":380293,"parentType":"article","parentId":18939,"uid":18160,"contents":"说到nginx了，就多说些吧<br>\n像cloudflare这样的装饰器模式，自然可以完成很多需求，但是有时候不能！！！<br>\n比如，我希望针对某一个单一的 请求做特殊处理！<br>\n<br>\nhttps://xxxx/index.html 就是 a操作<br>\nhttps://xxxx/fjkdlsalhgfjasdkhgfda 我希望是一个websocket操作<br>\n<b>怎么办呢？</b><br>\n<br>\n自然有办法！<br>\n搜索 src/http/ngx_http_core_module.c文件里的<br>\nngx_http_core_content_phase函数<br>\n<br>\n看到 ngx_http_finalize_request(r, r-&gt;content_handler(r)); 这句关键代码<br>\n也就是 content_handler 函数指针 <br>\n只有匹配了特定的 location以后，才会对content_handler赋值！<br>\n我们需要实现自己的 content_handler 函数指针指向的函数<br>\n<br>\n例如 src/http/modules/ngx_http_proxy_module.c<br>\n看到 ngx_http_proxy_commands 里 有 proxy_pass 这个字符串了没？<br>\n它 绑定了一个 函数 ngx_http_proxy_pass<br>\n翻译成人话版本：<br>\n如果，在 ngin短网址nf 文件 的 location里 看到了 proxy_pass 这个字符串 ，就会执行 ngx_http_proxy_pass 这个函数<br>\n我们点进去 看看这个函数在干嘛 <br>\n关键 函数 clcf-&gt;handler = ngx_http_proxy_handler; <br>\n这个 ngx_http_proxy_handler 就是在这里被指向了 content_handler ！！！<br>\n【不严谨了，，，， 为了你们好，真实情况 ngx_http_core_find_location 根据 location 去查找 clcf，然后把clcf的handler 设置给 了content_handler 】<br>\n<br>\n<br>\n-----------------------------------------------<br>\n无聊的人，可以自己写个mod给nginx，这样nginx就可以完成v2ray的工作<br>\n【VPS上只跑nginx就可以翻墙，不需要同时运行nginx和v2ray了~】<br>\n复制&nbsp;ngx_http_<b>proxy</b>_module.c 文件，取名 ngx_http_<b>faye</b>_module.c<br>\n表示我的mod<br>\n然后，根据我刚才的话，去实现ngx_http_faye_handler<br>\n<br>\n这里，我觉得<b>正常程序员</b>都应该可以做到的！！！<br>\n难得地方来了~<br>\nwebsocket协议的实现不会。。。<br>\n<br>\n好在我会<b>抄袭</b>。。。<br>\nhttps://github.com/signalwire/freeswitch/tree/master/src/mod/endpoints/mod_verto<br>\n使用 ws.c里的代码【websocket的缩写】，就可以完成建立 ws的握手和 数据读写<br>\n<br>\n接下来是第二步socks5协议的解析<br>\nhttps://github.com/rofl0r/microsocks/blob/master/sockssrv.c 里的代码，就可以完成socks5<br>\n<br>\n这样，就可以几乎没写什么代码的情况下<br>\n完成了，nginx的mod开发，支持了v2ray的 socks5 over wss来翻墙！！！<br>\n这里涉及了<br>\nngx_http_<b>proxy</b>_module.c<br>\nws.c<br>\nsockssrv.c<br>\n3个文件！ <br>\n<br>\n对了，光教你们写代码实现，没告诉你们怎么编译这个末端。。。。<br>\nUse the \"--add-module=\" when configuring NGINX to enable the module.<br>\n--------------------------------<br>\n希望你们有朝一日可以自己实现自己的翻墙软件吧。。。<br>\n<br>\n我自己是对研究这些代码<b>一分钱兴趣都没有了！！！</b><br>\n<b>懒得再写教程了！！！</b><br>\n<br>\n<b>我就想安安静静的发音乐！！！</b><br>\n<b>你们能不能多回复下我的音乐。。。我需要葱！！！</b>","date":"2020-05-16","agreeCount":2,"discussionCount":0}