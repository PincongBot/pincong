{"type":"article","id":1898,"title":"【更新服务器部署脚本】由近期GFW疯狂禁IP而催生的CDN翻墙方法","uid":1951,"topics":[112,470,1117],"contents":"由于近期GFW的大肆封锁IP,想必不少人想开始寻找下一代翻墙方法了吧。<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n以我个人经历来说，6.1 使用shadowsocks的搬瓦工ip被墙，6.2更换新的ip，开始使用无防护版v2ray。结果没一天，新的ip又被墙。 无奈之下本人开始寻求下一代翻墙方法。<br>\n<br>\n<br>\n<br>\n6.4成功利用cloudflare的免费cdn服务,完成了翻墙升级，现把简略步骤发于品葱，自由必胜。<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n前提条件:<br>\n<br>\n<br>\n<br>\n1.拥有境外vps<br>\n<br>\n<br>\n<br>\n2.拥有个人域名(免费或付费均可)<br>\n<br>\n<br>\n<br>\n3.注册cloudflare免费账号(当然，如果有不差钱的小伙伴，可以考虑cloudflare的付费服务)<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n域名操作方面:<br>\n<br>\n<br>\n<br>\n1.把个人域名的dns解析更改为 你注册cloudflare的dns服务器。<br>\n<br>\n<br>\n<br>\n2.在cloudflare上面添加自己vps的ip地址记录<br>\n<br>\n<br>\n<br>\n3.开启cloudflare的dns解析和http解析，并在crypto里面把加密方式设置为full(strict)<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\nvps操作方面:<br>\n<br>\n<br>\n<br>\n1.开放防火墙https 443端口<br>\n<br>\n<br>\n<br>\n2.配置https守护进程服务(Apache&nbsp; nginx&nbsp; caddy均可)<br>\n<br>\n<br>\n<br>\n3.将cloudflare生成的免费https证书配置到vps<br>\n<br>\n<br>\n<br>\n可参考 https://devanswers.co/configure-cloudflare-origin-ca-apache/<br>\n<br>\n<br>\n<br>\n4.配置https守护进程的proxy web socket代理<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\nv2ray方面:<br>\n<br>\n<br>\n<br>\n1.在vps上面安装v2ray<br>\n<br>\n<br>\n<br>\n2.设置web socket代理转发<br>\n<br>\n<br>\n<br>\n可参考<br>\n<br>\n<br>\n<br>\nhttps://ferrummagnus.com/2017/12/22/v2ray-websocket-tls-apache/<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n自由万岁<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n########################################<br>\n<br>\n<br>\n<br>\n6.5更新<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<b>域名管理</b><br>\n<br>\n<br>\n<br>\n1.注册免费域名<br>\n<br>\n<br>\n<br>\nhttps://www.vpscn.net/197.html<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n2.注册cloudflare账号并修改域名解析<br>\n<br>\n<br>\n<br>\ncloudflare入门三部曲<br>\n<br>\n<br>\n<br>\nhttps://support.cloudflare.com/hc/zh-cn/categories/200275218-%E5%85%A5%E9%97%A8<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n3.开启cloudflare dns和http解析代理<br>\n<br>\n<br>\n<br>\n在DNS选项里面填写自己域名对应的VPS地址<br>\n<br>\n<br>\n<br>\n<a href=\"https://ibb.co/qMsZnkv\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://ibb.co/qMsZnkv</a><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n在Crypto选项里选择full(strict)<br>\n<br>\n<br>\n<br>\n<a href=\"https://ibb.co/fGQ0qgL\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://ibb.co/fGQ0qgL</a><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n4.将cloudflare生成的CA证书保存至VPS服务器<br>\n<br>\n<br>\n<br>\n<a href=\"https://ibb.co/dpTtt2c\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://ibb.co/dpTtt2c</a><br>\n<br>\n<br>\n<br>\nCreate Certificate <br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\nNext<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<a href=\"https://ibb.co/ws5nmPK\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://ibb.co/ws5nmPK</a><br>\n<br>\n<br>\n<br>\n将Origin Certificate里面的内容复制 保存到VPS的/etc/cloudflare/example.com.pem文件(example.com为你自己的域名）<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n将Private Key里面的内容复制 保存到VPS的/etc/cloudflare/example.com.key文件(example.com为你自己的域名）<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<b>使用VPS apache服务器<br>\n</b>登录到自己的VPS服务器（以CentOS 7为例）<br>\n<br>\n<br>\n<br>\n1.<br>\n<br>\n<br>\n<br>\n安装apache服务器<br>\n<br>\n<br>\n<br>\n<pre>yum install httpd -y</pre><br>\n<br>\n<br>\n<br>\n<br>\n设置开机启动apache<br>\n<br>\n<br>\n<br>\n<pre>systemctl enable httpd </pre><br>\n<br>\n<br>\n<br>\n<br>\n安装Apache ssl模块<br>\n<br>\n<br>\n<br>\n<pre>yum install mod_ssl -y</pre><br>\n<br>\n<br>\n<br>\n<br>\n将以下配置信息复制到VPS的/etc/httpd/conf.d/example.com(你的域名).conf文件<br>\n<br>\n<br>\n<br>\n<pre>&lt;VirtualHost *:80&gt;</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; Servername example.com(你自己的域名)</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteEngine on</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteCond %{SERVER_NAME} =example.com(你自己的域名)</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URL} [END,NE,R=permanent]</pre><br>\n<pre>&lt;/VirtualHost&gt;</pre><br>\n<pre>&lt;VirtualHost *:443&gt;</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; Servername example.com(你自己的域名)</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; SSLEngine on</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; SSLCertificateFile /etc/cloudflare/example.com(你自己的域名).pem</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; SSLCertificateKeyFile /etc/cloudflare/example.com(你自己的域名).key</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteEngine On</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteCond %{HTTP:Upgrade} =websocket [NC]</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteRule /(.*)&nbsp; &nbsp; &nbsp; ws://localhost:12345/$1 [P,L]</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteCond %{HTTP:Upgrade} !=websocket [NC]</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; RewriteRule /(.*)&nbsp; &nbsp; &nbsp; http://localhost:12345/$1 [P,L]</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; SSLProxyEngine On</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; ProxyPass /ws http://localhost:12345</pre><br>\n<pre>&nbsp; &nbsp; &nbsp; &nbsp; ProxyPassReverse /ws http://127.0.0.1:12345</pre><br>\n<pre>&lt;/VirtualHost&gt;</pre><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n重启apache daemon<br>\n<br>\n<br>\n<br>\n<pre>systemctl restart httpd</pre><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n2.<br>\n<br>\n<br>\n<br>\n配置防火墙规则<br>\n<br>\n<br>\n<br>\n<pre>firewall-cmd --permanent --add-service=https<br>\nfirewall-cmd --reload</pre><br>\n<br>\n<br>\n<br>\n<br>\n3.<br>\n<br>\n<br>\n<br>\n安装curl工具<br>\n<br>\n<br>\n<br>\n<pre>yum install curl -y</pre><br>\n<br>\n<br>\n<br>\n<br>\n安装v2ray<br>\n<br>\n<br>\n<br>\n<pre>bash &lt;(curl -L -s https://install.direct/go.sh)</pre><br>\n<br>\n<br>\n<br>\n<br>\n设置开机启动v2ray daemon<br>\n<br>\n<br>\n<br>\n<pre>systemctl enable v2ray</pre><br>\n<br>\n<br>\n<br>\n<br>\n将/etc/v2ray/config.json文件修改为以下内容(注：ID部分不要修改)<br>\n<br>\n<br>\n<br>\n<pre>{<br>\n&nbsp; \"inbounds\": [{<br>\n&nbsp; &nbsp; \"port\": 12345,<br>\n&nbsp; &nbsp; \"listen\": \"127.0.0.1\",<br>\n&nbsp; &nbsp; \"protocol\": \"vmess\",<br>\n&nbsp; &nbsp; \"settings\": {<br>\n&nbsp; &nbsp; &nbsp; \"clients\": [<br>\n&nbsp; &nbsp; &nbsp; &nbsp; {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"id\": \"你自己的ID\", //此处不要修改<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"level\": 1,<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"alterId\": 64<br>\n&nbsp; &nbsp; &nbsp; &nbsp; }<br>\n&nbsp; &nbsp; &nbsp; ]<br>\n&nbsp; &nbsp; },<br>\n&nbsp; &nbsp; \"streamSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"network\": \"ws\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"wsSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"path\": \"/ws\"<br>\n&nbsp; &nbsp; &nbsp; &nbsp; }<br>\n&nbsp; &nbsp; }<br>\n&nbsp; }],<br>\n&nbsp; \"outbounds\": [{<br>\n&nbsp; &nbsp; \"protocol\": \"freedom\",<br>\n&nbsp; &nbsp; \"settings\": {}<br>\n&nbsp; },{<br>\n&nbsp; &nbsp; \"protocol\": \"blackhole\",<br>\n&nbsp; &nbsp; \"settings\": {},<br>\n&nbsp; &nbsp; \"tag\": \"blocked\"<br>\n&nbsp; }],<br>\n&nbsp; \"routing\": {<br>\n&nbsp; &nbsp; \"rules\": [<br>\n&nbsp; &nbsp; &nbsp; {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"type\": \"field\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"ip\": [\"geoip:private\"],<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"outboundTag\": \"blocked\"<br>\n&nbsp; &nbsp; &nbsp; }<br>\n&nbsp; &nbsp; ]<br>\n&nbsp; }<br>\n}</pre><br>\n<br>\n<br>\n<br>\n<br>\n重启v2ray daemon<br>\n<br>\n<br>\n<br>\n<pre>systemctl restart v2ray</pre><br>\n<br>\n<br>\n<br>\n<br>\n<b>恭喜！到现在我们已经完成了v2ray在服务器端的配置</b><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<b>-----------------客户端配置-------------------</b><br>\n<br>\n<br>\n<br>\n<b>Linux</b><br>\n<br>\n<br>\n<br>\n1.安装v2ray<br>\n<br>\n<br>\n<br>\n<pre>bash &lt;(curl -L -s https://install.direct/go.sh)</pre><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n2.修改/etc/v2ray/config.json文件为以下内容<br>\n<br>\n<br>\n<br>\n<pre>{<br>\n&nbsp; \"inbounds\": [{<br>\n&nbsp; &nbsp; \"port\": 1080,<br>\n&nbsp; &nbsp; \"listen\": \"127.0.0.1\",<br>\n&nbsp; &nbsp; \"protocol\": \"socks\",<br>\n&nbsp; &nbsp; \"settings\": {<br>\n&nbsp; &nbsp; &nbsp; \"udp\": true<br>\n&nbsp; &nbsp; }<br>\n&nbsp; }],<br>\n&nbsp; \"outbounds\": [{<br>\n&nbsp; &nbsp; \"protocol\": \"vmess\",<br>\n&nbsp; &nbsp; \"settings\": {<br>\n&nbsp; &nbsp; &nbsp; \"vnext\": [{<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"address\": \"example.com(填写你自己的域名)\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"port\": 443,<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"users\": [{ \"id\": \"你自己在VPS服务端的ID\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"level\": 1, \"alterId\": 64, \"security\": \"auto\"&nbsp; }]<br>\n&nbsp; &nbsp; &nbsp; }]<br>\n&nbsp; &nbsp; },<br>\n&nbsp; &nbsp; \"streamSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"network\": \"ws\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"security\": \"tls\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"tlsSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"serverName\": \"example.com(你自己的域名)\",<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"allowInsecure\": true<br>\n&nbsp; &nbsp; &nbsp; &nbsp; },<br>\n&nbsp; &nbsp; &nbsp; &nbsp; \"wsSettings\": {<br>\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \"path\": \"/ws\"<br>\n&nbsp; &nbsp; &nbsp; &nbsp; }<br>\n&nbsp; &nbsp; },<br>\n&nbsp; &nbsp; \"mux\": { \"enabled\": true }<br>\n&nbsp; }, {<br>\n&nbsp; &nbsp; \"protocol\": \"freedom\",<br>\n&nbsp; &nbsp; \"tag\": \"direct\",<br>\n&nbsp; &nbsp; \"settings\": {}<br>\n&nbsp; }],<br>\n&nbsp; \"routing\": {<br>\n&nbsp; &nbsp; \"domainStrategy\": \"IPOnDemand\",<br>\n&nbsp; &nbsp; \"rules\": [{<br>\n&nbsp; &nbsp; &nbsp; \"type\": \"field\",<br>\n&nbsp; &nbsp; &nbsp; \"ip\": [\"geoip:private\"],<br>\n&nbsp; &nbsp; &nbsp; \"outboundTag\": \"direct\"<br>\n&nbsp; &nbsp; }]<br>\n&nbsp; }<br>\n}</pre><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n3.配置v2ray daemon<br>\n<br>\n<br>\n<br>\n<pre>systemctl enable v2ray</pre><br>\n<pre>systemctl start v2ray</pre><br>\n<br>\n<br>\n<br>\n<br>\n4.设置proxy socks 5代理<br>\n<br>\n<br>\n<br>\n<b><a href=\"https://ibb.co/vzXdQ0w\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://ibb.co/vzXdQ0w</a></b><br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n<b>---------------------------------------------------------------------</b><br>\n<br>\n<br>\n<br>\n######################################<br>\n<br>\n6.11更新<br>\n<br>\n感谢各位葱友对我的支持，谢谢大家！<br>\n<br>\n脚本已经上传到GitHub&nbsp; <a href=\"https://github.com/KonaisPC/v2ray-apache-ws\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">https://github.com/KonaisPC/v2ray-apache-ws</a><br>\n<br>\n<br>\n<br>\n<b>使用之前</b><br>\n<br>\n<b>1.依据前文在cloudflare上配置好域名</b><br>\n<br>\n<b>2.已经保存好SSL .key 和 .pem文件到VPS服务器(需指定.key和.pem文件的绝对路径）</b><br>\n<br>\n<br>\n<br>\n欢迎大家一起帮助改进脚本<br>\n<br>\nAll men are created equal<br>\n<br>\n<br>\n<br>\n自由希望不可磨灭<br>\n<br>\n<br>\n<br>\n<br>\n<br>\n#####################################<br>\n<br>\n6.12更新<br>\n<br>\n脚本现已支持Ubuntu和CentOS，并自动输出对应的客户端配置文件到./client.json<br>\n<br>\n谢谢!","date":"2019-06-06","agreeCount":48,"discussionCount":0}