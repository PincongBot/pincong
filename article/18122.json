{"type":"article","id":18122,"title":"【TLS】ECDHE得到密钥后会发生什么","uid":18160,"topics":[8572,8575,8576,8577,8578],"contents":"网络太差了，我先写点别的东西，敷衍一下。。。<br>\n网络好了以后，再继续迷雾通第二篇！<br>\n<br>\n===============正文开始===================<br>\n扫盲地址<br>\nhttps://wiki.openssl.org/index.php/Elliptic_Curve_Diffie_Hellman<br>\n<br>\n注意到一句话<br>\n/* Never use a derived secret directly. Typically it is passed<br>\n* through some hash function to produce a key */<br>\n<br>\n也就是说，服务器收到浏览器的ClientHello�（钓鱼网站）��后，计算得到了premaster secret不会直接作为AES的密钥来使用！那么，我们就会思考一��（钓鱼网站）�钓鱼网站）�问题，那么AES的密钥到底是怎么来的呢？<br>\n<br>\n通过HKDF算法[https://suntus.github.io/2019/05/09/HKDF%E7%AE%97%E6%B3%95/]<br>\n<br>\n具体代码，我以火狐来讲解【因为Tor浏览器的代码基�（钓鱼网站）��火狐~】<br>\n打开代码文件security\\nss\\lib\\ssl\\tls13con.c<br>\n浏览器收到服务器返回的ServerHello，进入处理函数 tls13_HandleServerHelloPart2<br>\n跟着调（钓鱼网站）用 tls13_HandleServerKeyShare 得到 ECDHE协商出来的 premaster secret密钥<br>\n然后调用 tls13_ComputeHandshakeSecrets 得到 HKDF以后的真正密钥！<br>\n其�（钓鱼网站）� tls13_HandleServerKeyShare 内部调用了 tls13_HandleKeyShare 来计算得到ss-&gt;ssl3.hs.dheSecret【ecdhe协商出来的原始密钥，后面要用到】<br>\n因�（钓鱼网站）�过程就是github.io里说的那样，我就不废话了！！！<br>\n<br>\n回过头看server端部分：<br>\n服务器收到 浏览器的ClientHello以后，进入 tls13_HandleClientHelloPart2函数<br>\n进入 tls13_HandleClientKeyShare 函数 <br>\n然后是 tls13_HandleKeyShare 得到了 原始密钥<br>\n接下来是HKDF部分<br>\n看函数 tls13_SendServerHelloSequence -&gt; tls13_SendEncryptedServerSequence<br>\ntls13_ComputeHandshakeSecrets，走到这里，就和客户端的流程一样，所以得到了同样的密钥","date":"2020-04-24","agreeCount":10,"discussionCount":0}