{"type":"question","id":1473,"title":"nextcloud 搭建自己的存储服务器","uid":1339,"topics":[156],"contents":"前言<br>\nnextcloud 是owncloud的一个分支，<a href=\"https://civihosting.com/blog/nextcloud-vs-owncloud/\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">对比参考</a>。 此教程为在Arch Linux平台上搭建的教程，Arch Linux 软件源包含nextcloud。安装Arch时推荐格式化一个分区作为数据分区，日常使用也推荐将home单独一个分区。我只是用小主机搭建了可以内网使用的，外网使用需要公共ip，使用**云的不要拍砖（千万不要够买&nbsp;<b>orico 奥睿科</b>&nbsp;的任何产品）. ssh服务启用，更多参考wiki<br>\n<pre>pacman -Syu openssh<br>\nsystemctl start sshd.service<br>\nsystemctl enable sshd.service</pre><br>\n安装<br>\nnextcloud需要的软件为： Nextcloud requires several components:[1]<br>\n<ul><li>A web server: Apache or nginx</li><li>A database: MariaDB/MySQL, PostgreSQL or Oracle</li><li>PHP with additional modules</li></ul><br>\n以上列表内容选择其中一个即可，我对apache和nginx都不熟悉，按首字母排序选择apache?。数据库推荐MariaDB，MariaDB是MySQL的一个变种。php为必须安装，你可以编译安装nextcloud。<br>\n执行命令安装相关包:<br>\n<pre>pacman -S nextcloud mariadb php php-intl php-admin php-apache</pre><br>\n<a href=\"https://wiki.archlinux.org/index.php/Nextcloud#Setup\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">Pacman (hook)钩子</a>&nbsp;要在更新时自动升级Nextcloud数据库，需要创建pacman钩子：<br>\n<pre>/etc/pacman.d/hooks/nextcloud.hook</pre><br>\n<hr><br>\n<pre>[Trigger]<br>\nOperation = Install<br>\nOperation = Upgrade<br>\nType = Package<br>\nTarget = nextcloud<br>\nTarget = nextcloud-app-*<br>\n<br>\n[Action]<br>\nDescription = Update Nextcloud installation<br>\nWhen = PostTransaction<br>\nExec = /usr/bin/runuser -u http -- /usr/bin/php /usr/share/webapps/nextcloud/occ upgrade</pre><br>\n配置mysql/mariadb。<br>\nmariadb需要初始化目录<br>\n<pre>sudo mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql</pre><br>\n<pre>sudo systemctl enable mariadb.service<br>\nsudo systemctl start mariadb.service</pre><br>\n<blockquote>systemctl简单介绍，enable 开机自动启动，start 启动。</blockquote><br>\n如果你是新安装mysql需要先创建root用户，然后再创建其它用户和分配权限。创建用户和分配权限不是必须操作，如果不创建用户和分配权限，它可以方便你和其他人删库跑路。<br>\n<pre><br>\nmysql -u root -p # 登录<br>\n<br>\nmysql&gt; CREATE DATABASE `nextcloud` DEFAULT CHARACTER SET `utf8` COLLATE `utf8_unicode_ci`;<br>\n<br>\nmysql&gt; CREATE USER `yourname`@'localhost' IDENTIFIED BY 'password';<br>\n<br>\n# 授权允许访问<br>\nmysql&gt; GRANT ALL PRIVILEGES ON `nextcloud`.* TO `nextcloud`@`localhost`;<br>\n</pre><br>\n配置PHP<br>\n编辑&nbsp;<b>/etc/php/php.ini</b><br>\n取消注释以下行或内容，删除前边的 #<br>\n<pre>extension=gd<br>\niconv<br>\n#mysql<br>\nextension=pdo_mysql<br>\nextension=mysqli</pre><br>\n配置Apache<br>\nCopy the Apache configuration file to the configuration directory:<br>\n<pre><br>\ncp /etc/webapps/nextcloud/apache.example.conf /etc/httpd/conf/extra/nextcloud.conf # 复制配置</pre><br>\n<pre>&lt;IfModule mod_alias.c&gt;<br>\n&nbsp; &nbsp; Alias /nextcloud /usr/share/webapps/nextcloud/<br>\n&lt;/IfModule&gt;<br>\n<br>\n&lt;Directory /usr/share/webapps/nextcloud/&gt;<br>\n&nbsp; &nbsp; Options FollowSymlinks<br>\n&nbsp; &nbsp; AllowOverride all<br>\n&nbsp; &nbsp; Require all granted<br>\n&nbsp; &nbsp; php_admin_value open_basedir \"/srv/http/:/dev/urandom:/tmp/:/usr/share/pear/:/usr/share/webapps/nextcloud/:/etc/webapps/nextcloud:/home/nextcloud\"<br>\n&lt;/Directory&gt;<br>\n&lt;!-- http 端口 --&gt;<br>\n&lt;VirtualHost *:80&gt;<br>\n&nbsp; &nbsp; ServerAdmin foo@foofarm.com<br>\n&nbsp; &nbsp; DocumentRoot /usr/share/webapps/nextcloud<br>\n&nbsp; &nbsp; ServerName nextcloud.foo.com<br>\n&nbsp; &nbsp; ErrorLog /var/log/httpd/nextcloud.foo.info-error_log<br>\n&nbsp; &nbsp; CustomLog /var/log/httpd/nextcloud.foo.info-access_log common<br>\n&lt;/VirtualHost&gt;</pre><br>\nModify the file according to your preferences. By default it includes an alias for /nextcloud pointing to /usr/share/webapps/nextcloud.<br>\nAnd include it in /etc/httpd/conf/httpd.conf:<br>\n修改 /etc/httpd/conf/httpd.conf<br>\n加入<br>\n<pre>Include conf/extra/nextcloud.conf</pre><br>\n<a href=\"https://wiki.archlinux.org/index.php/Apache_HTTP_Server#PHP\" rel=\"nofollow noreferrer noopener\" target=\"_blank\">修改 /etc/httpd/conf/httpd.conf</a><br>\n注释如下行<br>\n<pre>LoadModule mpm_event_module modules/mod_mpm_event.so<br>\nand uncomment the line:</pre><br>\n取消注释如下行<br>\n<pre>LoadModule mpm_prefork_module modules/mod_mpm_prefork.so</pre><br>\nLoadModule的列表最后添加<br>\n<pre>LoadModule php7_module modules/libphp7.so<br>\nAddHandler php7-script .php</pre><br>\n<pre>Include conf/extra/php7_module.conf</pre><br>\n<pre>cat /etc/group #查看用户组</pre><br>\n储存目录设置<br>\n可以看到有http用户组，这个就是webserver 的用户组，这一点和nextcloud官方文档的www不相同(可能是发行版缘故)。<br>\n初始化存储目录<br>\n<pre>mkdir -p /usr/share/webapps/nextcloud/data<br>\nchown http:http /usr/share/webapps/nextcloud/data<br>\nchown http:http /usr/share/webapps/nextcloud/apps<br>\nchmod 750 /usr/share/webapps/nextcloud/data<br>\nchmod 750 /usr/share/webapps/nextcloud/apps</pre><br>\n创建数据目录，默认是在：/usr/share/webapps/nextcloud/data。之前说过单独分区，我是把单独分区挂载到home上，所以在home创建文件夹nextcloud。<br>\n<pre>mkdir nextcloud<br>\nchown http:http /home/nextcloud/<br>\nsystemctl start httpd.service<br>\nsystemctl enable httpd.service</pre><br>\n输入你的服务器IP地址，例如192.168.1.101,可以看到让你配置数据库、用户名、和数据(文件)存放地址,填进去就好了。你的用户名(管理员)和密码(非明文)存放在/usr/share/webapps/nextcloud/data的php配置中.<br>\n<blockquote>由于是在安装后一个多月写的此文，所以可能部分细节忘记了</blockquote><br>\n优化<br>\n进入nextcloud 点击头像，设置→管理→ 基本设置有优化提示，按照操作完成（需要linux基础)。 点击头像→用户，创建用户和管理用户","date":"2019-01-19","agreeCount":4,"discussionCount":0}